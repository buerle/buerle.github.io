<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="postgis 记录亿级数据测试资料参考理解  坐标系理解和距离计算 坐标系转换 火星坐标系偏移   创建测试需要的基本信息 创建数据库 postgis_test1create database postgis_test; 创建POSTGIS扩展123CREATE EXTENSION postgis;CREATE EXTENSION postgis_topology;CREATE EXTENSIO">
<meta name="keywords" content="dev,note,postgres,postgresql,golang,php,linux,web,mysql,postgis">
<meta property="og:type" content="article">
<meta property="og:title" content="postgis 记录亿级数据测试">
<meta property="og:url" content="http://shuohua.vip/2018/09/30/postgres-postgis/index.html">
<meta property="og:site_name" content="buerle">
<meta property="og:description" content="postgis 记录亿级数据测试资料参考理解  坐标系理解和距离计算 坐标系转换 火星坐标系偏移   创建测试需要的基本信息 创建数据库 postgis_test1create database postgis_test; 创建POSTGIS扩展123CREATE EXTENSION postgis;CREATE EXTENSION postgis_topology;CREATE EXTENSIO">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-11-23T03:56:27.178Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="postgis 记录亿级数据测试">
<meta name="twitter:description" content="postgis 记录亿级数据测试资料参考理解  坐标系理解和距离计算 坐标系转换 火星坐标系偏移   创建测试需要的基本信息 创建数据库 postgis_test1create database postgis_test; 创建POSTGIS扩展123CREATE EXTENSION postgis;CREATE EXTENSION postgis_topology;CREATE EXTENSIO">






  <link rel="canonical" href="http://shuohua.vip/2018/09/30/postgres-postgis/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>postgis 记录亿级数据测试 | buerle</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">buerle</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shuohua.vip/2018/09/30/postgres-postgis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="buerle">
      <meta itemprop="description" content="dev,note,postgres,postgresql,golang,php,linux,web,mysql,postgis">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buerle">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">postgis 记录亿级数据测试
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-30 11:52:10" itemprop="dateCreated datePublished" datetime="2018-09-30T11:52:10+08:00">2018-09-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-23 11:56:27" itemprop="dateModified" datetime="2018-11-23T11:56:27+08:00">2018-11-23</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="postgis-记录亿级数据测试"><a href="#postgis-记录亿级数据测试" class="headerlink" title="postgis 记录亿级数据测试"></a>postgis 记录亿级数据测试</h2><h3 id="资料参考理解"><a href="#资料参考理解" class="headerlink" title="资料参考理解"></a>资料参考理解</h3><blockquote>
<ul>
<li><a href="https://www.jianshu.com/p/be5049ad8884" target="_blank" rel="noopener">坐标系理解和距离计算</a></li>
<li><a href="https://github.com/wandergis/coordtransform" target="_blank" rel="noopener">坐标系转换</a></li>
<li><a href="https://www.zhihu.com/question/19883280/answer/102190429" target="_blank" rel="noopener">火星坐标系偏移</a></li>
</ul>
</blockquote>
<h2 id="创建测试需要的基本信息"><a href="#创建测试需要的基本信息" class="headerlink" title="创建测试需要的基本信息"></a>创建测试需要的基本信息</h2><hr>
<h3 id="创建数据库-postgis-test"><a href="#创建数据库-postgis-test" class="headerlink" title="创建数据库 postgis_test"></a>创建数据库 <code>postgis_test</code></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> postgis_test;</span><br></pre></td></tr></table></figure>
<h3 id="创建POSTGIS扩展"><a href="#创建POSTGIS扩展" class="headerlink" title="创建POSTGIS扩展"></a>创建<code>POSTGIS</code>扩展</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTENSION postgis;</span><br><span class="line">CREATE EXTENSION postgis_topology;</span><br><span class="line">CREATE EXTENSION fuzzystrmatch;</span><br></pre></td></tr></table></figure>
<h3 id="创建-t-user-position-测试表"><a href="#创建-t-user-position-测试表" class="headerlink" title="创建 t_user_position 测试表"></a>创建 <code>t_user_position</code> 测试表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据量表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"public"</span>.<span class="string">"t_user_position"</span> (</span><br><span class="line">  <span class="string">"id"</span> <span class="built_in">serial8</span>,</span><br><span class="line">  <span class="string">"status"</span> int2,</span><br><span class="line">  <span class="string">"keyword"</span> <span class="built_in">int8</span>,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">"t_user_position_pkey"</span> PRIMARY <span class="keyword">KEY</span> (<span class="string">"id"</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 添加GIS几何坐标类型</span></span><br><span class="line"><span class="keyword">select</span> AddGeometryColumn(<span class="string">'t_user_position'</span>,<span class="string">'position'</span>,<span class="number">4326</span>,<span class="string">'POINT'</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 将几何列添加到现有属性表中, 使用EPSG:4326坐标系的投影来创建记录坐标</p>
<p>text AddGeometryColumn**(<code>varchar table_name，varchar column_name，integer srid，varchar type，integer dimension，boolean use_typmod = true</code>) ;</p>
</blockquote>
<h2 id="创建生成数据的存储过程"><a href="#创建生成数据的存储过程" class="headerlink" title="创建生成数据的存储过程"></a>创建生成数据的存储过程</h2><hr>
<h3 id="存储过程生成数据"><a href="#存储过程生成数据" class="headerlink" title="存储过程生成数据"></a>存储过程生成数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE FUNCTION &quot;public&quot;.&quot;generated_user_position&quot;(&quot;limit&quot; int8)</span><br><span class="line">  RETURNS &quot;pg_catalog&quot;.&quot;void&quot; AS $BODY$</span><br><span class="line">  	declare vStart BIGINT; </span><br><span class="line">	declare vLimit BIGINT;</span><br><span class="line">	declare BatchNum BIGINT;</span><br><span class="line">BEGIN</span><br><span class="line">  -- Routine body goes here...</span><br><span class="line">	BatchNum := 10000;</span><br><span class="line">	vLimit := $1;</span><br><span class="line">	select max(uid) INTO vStart from t_user_position;</span><br><span class="line">	vStart := vStart + 1;</span><br><span class="line">	if ( vStart IS NULL ) then</span><br><span class="line">		vStart := 1;</span><br><span class="line">	end if;</span><br><span class="line">	raise notice &apos;max id %&apos;, vStart;   </span><br><span class="line">	loop    </span><br><span class="line">		insert into t_user_position  </span><br><span class="line">				select id ,(random()*1)::integer, (random()*(20-1)+1)::integer,    </span><br><span class="line">						ST_SetSRID(ST_Point(    </span><br><span class="line">								round((random()*(135.085831-73.406586)+73.406586)::numeric,6),    </span><br><span class="line">								round((random()*(53.880950-3.408477)+3.408477)::numeric,6)    </span><br><span class="line">						),4326)    </span><br><span class="line">				from generate_series(vStart, vStart+BatchNum - 1) as id;</span><br><span class="line">		vStart := vStart + BatchNum;</span><br><span class="line">		raise notice &apos;start:% batchNum:% limit:%&apos;, vStart, BatchNum, vLimit;  </span><br><span class="line">		if( vStart &gt; vLimit ) then    </span><br><span class="line">			RETURN; </span><br><span class="line">		end if;    </span><br><span class="line">	end loop;    </span><br><span class="line">  RETURN;</span><br><span class="line">END</span><br><span class="line">$BODY$</span><br><span class="line">  LANGUAGE plpgsql VOLATILE</span><br><span class="line">  COST 100</span><br></pre></td></tr></table></figure>
<blockquote>
<p>经纬度这个范围正好包含中国的地区的地图<br>135.085831-73.406586<br>53.880950-3.408477</p>
</blockquote>
<h3 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行名称生成1个亿的测试数据</span></span><br><span class="line"><span class="keyword">select</span> generated_user_position(<span class="number">100000000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="也可以使用pgbench生成数据"><a href="#也可以使用pgbench生成数据" class="headerlink" title="也可以使用pgbench生成数据"></a>也可以使用<code>pgbench</code>生成数据</h3><ul>
<li>保存下面语句到 generated_user_position.sql</li>
<li>执行 <code>pgbench</code>测试工具生成测试数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存生成数据sql 每次插入 10000 条记录</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"INSERT INTO t_user_position (status,keyword,POSITION) SELECT (random()*1) :: INTEGER,(random()*(20-1)+1) :: INTEGER,ST_SetSRID (ST_Point (round((random()*(135.085831-73.406586)+73.406586) :: NUMERIC,6),round((random()*(53.880950-3.408477)+3.408477) :: NUMERIC,6)),4326) FROM generate_series (1,10000);"</span> &gt; generated_user_position.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行生成数据命令</span></span><br><span class="line">$ pgbench -U postgres postgis_test -M prepared -n -r -f ./generated_user_position.sql -P 1 -c 20 -j 20 -T 20</span><br></pre></td></tr></table></figure>
<blockquote>
<p>transaction type: ./generated_user_position.sql<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 20<br>number of threads: 20<br>duration: 20 s<br>number of transactions actually processed: 300<br>latency average = 1350.378 ms<br>latency stddev = 1914.043 ms<br>tps = 14.777446 (including connections establishing)<br>tps = 14.779913 (excluding connections establishing)<br>script statistics:</p>
<ul>
<li>statement latencies in milliseconds:<br>1340.948  INSERT INTO t_user_position (status,keyword,POSITION) SELECT (random()<em>1) :: INTEGER,(random()</em>(20-1)+1) :: INTEGER,ST_SetSRID (ST_Point (round((random()<em>(135.085831-73.406586)+73.406586) :: NUMERIC,6),round((random()</em>(53.880950-3.408477)+3.408477) :: NUMERIC,6)),4326) FROM generate_series (1,10000);</li>
</ul>
</blockquote>
<blockquote>
<p>检测测试 20 个客户 ，运行20s<br>生成 processed: 300*10000 = 300w数据</p>
</blockquote>
<h4 id="再次执行脚本运行时间为1个小时"><a href="#再次执行脚本运行时间为1个小时" class="headerlink" title="再次执行脚本运行时间为1个小时"></a>再次执行脚本运行时间为<code>1个小时</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pgbench -U postgres postgis_test -M prepared -n -r -f ./generated_user_position.sql -P 1 -c 20 -j 20 -T 3600</span><br></pre></td></tr></table></figure>
<h4 id="查看运行结果"><a href="#查看运行结果" class="headerlink" title="查看运行结果"></a>查看运行结果</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scaling factor: 1</span><br><span class="line">query mode: prepared</span><br><span class="line">number of clients: 14</span><br><span class="line">number of threads: 14</span><br><span class="line">duration: 3600 s</span><br><span class="line">number of transactions actually processed: 24769</span><br><span class="line">latency average = 2036.070 ms</span><br><span class="line">latency stddev = 2765.040 ms</span><br><span class="line">tps = 6.874965 (including connections establishing)</span><br><span class="line">tps = 6.874970 (excluding connections establishing)</span><br><span class="line">script statistics:</span><br><span class="line"> - statement latencies <span class="keyword">in</span> milliseconds:</span><br><span class="line">      2027.817  INSERT INTO t_user_position (status,keyword,POSITION) SELECT (random()*1) :: INTEGER,(random()*(20-1)+1) :: INTEGER,ST_SetSRID (ST_Point (round((random()*(135.085831-73.406586)+73.406586) :: NUMERIC,6),round((random()*(53.880950-3.408477)+3.408477) :: NUMERIC,6)),4326) FROM generate_series (1,10000);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成 processed: 24769*10000 = 2.4亿数据,<br>tps = 6.874970/s  每秒插入6.8w</p>
</blockquote>
<h4 id="count-查询数据"><a href="#count-查询数据" class="headerlink" title="count 查询数据"></a>count 查询数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN ANALYZE SELECT count(id) from t_user_position limit 1;</span><br><span class="line"></span><br><span class="line">QUERY PLAN</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Limit  (cost=6182050.51..6182050.52 rows=1 width=8) (actual time=525967.304..525967.872 rows=1 loops=1)</span><br><span class="line">   -&gt;  Aggregate  (cost=6182050.51..6182050.52 rows=1 width=8) (actual time=525966.797..525966.797 rows=1 loops=1)</span><br><span class="line">         -&gt;  Seq Scan on t_user_position  (cost=0.00..5504595.41 rows=270982041 width=8) (actual time=0.017..502297.811 rows=270990000 loops=1)</span><br><span class="line"> Planning time: 0.688 ms</span><br><span class="line"> Execution time: 525968.782 ms</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>可以看到数据大概生成2.7亿   </li>
<li>count 执行时间 525968.782 ms /1000/60 = 8.766146367 minute , 可以看到数据是不走索引的</li>
<li>通过 max id 查找一下尝试一下</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">postgis_test=<span class="comment"># SELECT max(id) from t_user_position limit 1;</span></span><br><span class="line"></span><br><span class="line">    max</span><br><span class="line">-----------</span><br><span class="line"> 271065072</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgis_test=<span class="comment"># EXPLAIN ANALYZE SELECT max(id) from t_user_position limit 1;</span></span><br><span class="line"></span><br><span class="line">Limit  (cost=0.61..0.62 rows=1 width=8) (actual time=0.040..0.041 rows=1 loops=1)</span><br><span class="line">   InitPlan 1 (returns <span class="variable">$0</span>)</span><br><span class="line">     -&gt;  Limit  (cost=0.57..0.61 rows=1 width=8) (actual time=0.033..0.034 rows=1 loops=1)</span><br><span class="line">           -&gt;  Index Only Scan Backward using t_user_position_pkey on t_user_position  (cost=0.57..10504372.29 rows=270982041 width=8) (actual time=0.033..0.033 rows=1 loops=1)</span><br><span class="line">                 Index Cond: (id IS NOT NULL)</span><br><span class="line">                 Heap Fetches: 1</span><br><span class="line">   -&gt;  Result  (cost=0.61..0.62 rows=1 width=8) (actual time=0.039..0.039 rows=1 loops=1)</span><br><span class="line"> Planning time: 0.180 ms</span><br><span class="line"> Execution time: 0.091 ms</span><br><span class="line">(9 rows)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以max走索引<code>t_user_position_pkey</code>查询，很快就查询出来，因为我们id是自增的，在正常业务是没有办法通过max 查询的， 后面来谈一下count 的优化</p>
<p>TIPS:<br>执行sql 语句的时间显示时间<br><code>\timing on</code><br>关闭时间<br><code>\timing off</code></p>
</blockquote>
<h4 id="查看表空间"><a href="#查看表空间" class="headerlink" title="查看表空间"></a>查看表空间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgis_test=# \dt+ t_user_position</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Schema</th>
<th>Name</th>
<th>Type</th>
<th>Owner</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>public</td>
<td>t_user_position</td>
<td>table</td>
<td>postgres</td>
<td>21 GB</td>
</tr>
</tbody>
</table>
<blockquote>
<p>表数据大小 21 GB </p>
</blockquote>
<h4 id="查看表自增主键索引大小"><a href="#查看表自增主键索引大小" class="headerlink" title="查看表自增主键索引大小"></a>查看表自增主键索引大小</h4><table>
<thead>
<tr>
<th>Schema</th>
<th>Name</th>
<th>Type</th>
<th>Owner</th>
<th>Table</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>public</td>
<td>t_user_position_pkey</td>
<td>index</td>
<td>postgres</td>
<td>t_user_position</td>
<td>5796 MB</td>
</tr>
</tbody>
</table>
<blockquote>
<p>自增主键索引 5796 MB</p>
</blockquote>
<h4 id="我们通过-pg-lt-gt-操作符在没有索引的情况下查询附近1000个人"><a href="#我们通过-pg-lt-gt-操作符在没有索引的情况下查询附近1000个人" class="headerlink" title="我们通过 pg  &lt;-&gt; 操作符在没有索引的情况下查询附近1000个人"></a>我们通过 pg  <code>&lt;-&gt;</code> 操作符在没有索引的情况下查询附近1000个人</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">ANALYZE</span> <span class="keyword">SELECT</span>*,st_astext (<span class="keyword">POSITION</span>),ST_Distance (<span class="keyword">POSITION</span>,ST_SetSRID (ST_Point (<span class="number">113.961553</span>,<span class="number">22.539728</span>),<span class="number">4326</span>),<span class="literal">TRUE</span>) <span class="keyword">AS</span> idistance <span class="keyword">FROM</span> t_user_position <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">POSITION</span>&lt;-&gt; ST_SetSRID (ST_Point (<span class="number">113.961319</span>,<span class="number">22.539881</span>),<span class="number">4326</span>) <span class="keyword">ASC</span> <span class="keyword">LIMIT</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">QUERY PLAN</span><br><span class="line"></span><br><span class="line"> Limit  (cost=21039703.55..21041846.05 rows=1000 width=98) (actual time=132496.383..132499.403 rows=1000 loops=1)</span><br><span class="line">   -&gt;  Result  (cost=21039703.55..601618726.39 rows=270982041 width=98) (actual time=132496.379..132499.341 rows=1000 loops=1)</span><br><span class="line">         -&gt;  Sort  (cost=21039703.55..21717158.65 rows=270982041 width=58) (actual time=132483.568..132483.671 rows=1000 loops=1)</span><br><span class="line">               Sort Key: (("position" &lt;-&gt; '0101000020E610000080812040867D5C4056BB26A4358A3640'::geometry))</span><br><span class="line">               Sort Method: top-N heapsort Memory: 189kB</span><br><span class="line">               -&gt;  Seq Scan on t_user_position  (cost=0.00..6182050.51 rows=270982041 width=58) (actual time=0.553..101779.370 rows=270990000 loops=1)</span><br><span class="line"> Planning time: 9.222 ms</span><br><span class="line"> Execution time: 132499.521 ms</span><br><span class="line">(8 rows)</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>可以看到运行时间在 132499.521/1000/60 = 2.20832535 minute</li>
<li>Seq Scan 101779.370/1000 = 101.77937 s</li>
<li>Sort  (132483.671 - 101779.370) / 1000 = 30.704301 s</li>
<li>Result 132499.341- 132483.671 = 15.67 ms<br>可以看到以前时间主要花在查找上面</li>
</ul>
</blockquote>
<h4 id="查询的数据结果"><a href="#查询的数据结果" class="headerlink" title="查询的数据结果"></a>查询的数据结果</h4><table>
<thead>
<tr>
<th>id</th>
<th>st_astext</th>
<th>idistance</th>
</tr>
</thead>
<tbody>
<tr>
<td>212125300</td>
<td>POINT(113.958706 22.538918)</td>
<td>306.29108344</td>
</tr>
<tr>
<td>259764467</td>
<td>POINT(113.964562 22.541366)</td>
<td>358.75773649</td>
</tr>
<tr>
<td>188832099</td>
<td>POINT(113.96364 22.542684)</td>
<td>391.45835585</td>
</tr>
<tr>
<td>260557959</td>
<td>POINT(113.957639 22.540103)</td>
<td>404.75615328</td>
</tr>
<tr>
<td>18078100</td>
<td>POINT(113.963677 22.537035)</td>
<td>369.69102299</td>
</tr>
<tr>
<td>109558965</td>
<td>POINT(113.957841 22.541181)</td>
<td>414.35607167</td>
</tr>
<tr>
<td>101211709</td>
<td>POINT(113.963286 22.54359)</td>
<td>463.33497323</td>
</tr>
<tr>
<td>193900255</td>
<td>POINT(113.963573 22.544076)</td>
<td>524.40995991</td>
</tr>
<tr>
<td>35525764</td>
<td>POINT(113.966389 22.541076)</td>
<td>519.37548978</td>
</tr>
<tr>
<td>22927924</td>
<td>POINT(113.956781 22.542693)</td>
<td>590.56231824</td>
</tr>
<tr>
<td>269361727</td>
<td>POINT(113.957438 22.543689)</td>
<td>609.56802747</td>
</tr>
<tr>
<td>192385213</td>
<td>POINT(113.962308 22.546894)</td>
<td>797.33745001</td>
</tr>
<tr>
<td>196045014</td>
<td>POINT(113.96392 22.533153)</td>
<td>767.73509421</td>
</tr>
<tr>
<td>75104350</td>
<td>POINT(113.968542 22.539115)</td>
<td>722.13554841</td>
</tr>
<tr>
<td>143625689</td>
<td>POINT(113.961648 22.547241)</td>
<td>832.02956681</td>
</tr>
<tr>
<td>224364913</td>
<td>POINT(113.960128 22.547239)</td>
<td>844.5681176</td>
</tr>
<tr>
<td>225272267</td>
<td>POINT(113.953899 22.54128)</td>
<td>805.87795231</td>
</tr>
<tr>
<td>12176769</td>
<td>POINT(113.966965 22.534668)</td>
<td>789.88319472</td>
</tr>
<tr>
<td>11633764</td>
<td>POINT(113.966044 22.533045)</td>
<td>872.42126033</td>
</tr>
<tr>
<td>38660812</td>
<td>POINT(113.953404 22.535082)</td>
<td>983.56659224</td>
</tr>
<tr>
<td>14788752</td>
<td>POINT(113.960114 22.549081)</td>
<td>1046.25326568</td>
</tr>
<tr>
<td>43141104</td>
<td>POINT(113.969409 22.535312)</td>
<td>944.57378198</td>
</tr>
<tr>
<td>93490972</td>
<td>POINT(113.953899 22.533531)</td>
<td>1044.44377693</td>
</tr>
<tr>
<td>117023748</td>
<td>POINT(113.970436 22.544949)</td>
<td>1081.2990849</td>
</tr>
<tr>
<td>128490752</td>
<td>POINT(113.971919 22.539125)</td>
<td>1068.40872177</td>
</tr>
<tr>
<td>107727455</td>
<td>POINT(113.96313 22.550433)</td>
<td>1196.49421852</td>
</tr>
<tr>
<td>82582292</td>
<td>POINT(113.970578 22.545292)</td>
<td>1114.2155175</td>
</tr>
<tr>
<td>57639859</td>
<td>POINT(113.950712 22.542211)</td>
<td>1148.56727107</td>
</tr>
<tr>
<td>12808426</td>
<td>POINT(113.963548 22.529243)</td>
<td>1179.08121056</td>
</tr>
<tr>
<td>172506983</td>
<td>POINT(113.953068 22.54706)</td>
<td>1192.06192716</td>
</tr>
<tr>
<td>179486115</td>
<td>POINT(113.959743 22.550751)</td>
<td>1234.77875041</td>
</tr>
<tr>
<td>19294587</td>
<td>POINT(113.968687 22.531127)</td>
<td>1202.38947923</td>
</tr>
<tr>
<td>119634065</td>
<td>POINT(113.949965 22.538391)</td>
<td>1201.18619661</td>
</tr>
<tr>
<td>100890225</td>
<td>POINT(113.9725 22.537201)</td>
<td>1160.34207652</td>
</tr>
<tr>
<td>194107529</td>
<td>POINT(113.972286 22.544548)</td>
<td>1226.30452025</td>
</tr>
<tr>
<td>211232137</td>
<td>POINT(113.972631 22.53595)</td>
<td>1213.94415163</td>
</tr>
</tbody>
</table>
<h2 id="添加索引测试"><a href="#添加索引测试" class="headerlink" title="添加索引测试"></a>添加索引测试</h2><hr>
<h4 id="添加索引"><a href="#添加索引" class="headerlink" title="添加索引"></a>添加索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">"gist_t_user_position"</span> <span class="keyword">ON</span> <span class="string">"public"</span>.<span class="string">"t_user_position"</span> <span class="keyword">USING</span> gist (</span><br><span class="line">  <span class="string">"position"</span> <span class="string">"public"</span>.<span class="string">"gist_geometry_ops_2d"</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>CREATE INDEX<br>Time: 33627796.935 ms (09:20:27.797)</p>
<p>索引消耗的时间还是很长 <code>9个多小时</code>才跑完</p>
</blockquote>
<h3 id="索引大小"><a href="#索引大小" class="headerlink" title="索引大小"></a>索引大小</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看索引大小</span><br><span class="line">postgis_test=# \di+</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Schema</th>
<th>Name</th>
<th>Type</th>
<th>Owner</th>
<th>Table</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>public</td>
<td>gist_t_user_position</td>
<td>index</td>
<td>postgres</td>
<td>t_user_position</td>
<td>14 GB</td>
<td></td>
</tr>
<tr>
<td>public</td>
<td>t_user_position_pkey</td>
<td>index</td>
<td>postgres</td>
<td>t_user_position</td>
<td>5796 MB</td>
</tr>
</tbody>
</table>
<blockquote>
<p>t_user_position_pkey 主键索引</p>
</blockquote>
<h4 id="添加测试脚本"><a href="#添加测试脚本" class="headerlink" title="添加测试脚本"></a>添加测试脚本</h4><ul>
<li>vim test_random_position.sql</li>
<li>wq! 写入脚本并保存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\set x random(73.33,135.05)</span><br><span class="line">\set y random(3.51,53.33)</span><br><span class="line">SELECT uid,st_astext (position),ST_Distance (position,ST_SetSRID (ST_Point (:x,:y),4326),TRUE) AS idistance FROM t_user_position ORDER BY position &lt;-&gt; ST_SetSRID (ST_Point (:x,:y),4326) ASC LIMIT 1000;</span><br></pre></td></tr></table></figure>
<h4 id="执行pgbench"><a href="#执行pgbench" class="headerlink" title="执行pgbench"></a>执行<code>pgbench</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pgbench -h 172.16.1.209 -p 5432 -U postgres postgis_test -M prepared -n -r -f ./test_random_position.sql -P 1 -c 5 -j 5 -T 60</span><br></pre></td></tr></table></figure>
<blockquote>
<p>为了减少pgbench对postgres主机的影响，把脚本反正内网请求</p>
</blockquote>
<h4 id="limit-1000"><a href="#limit-1000" class="headerlink" title="limit 1000"></a>limit 1000</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">transaction type: ./test_random_position.sql</span><br><span class="line">scaling factor: 1</span><br><span class="line">query mode: prepared</span><br><span class="line">number of clients: 5</span><br><span class="line">number of threads: 5</span><br><span class="line">duration: 60 s</span><br><span class="line">number of transactions actually processed: 524</span><br><span class="line">latency average = 575.313 ms</span><br><span class="line">latency stddev = 193.551 ms</span><br><span class="line">tps = 8.667237 (including connections establishing)</span><br><span class="line">tps = 8.670182 (excluding connections establishing)</span><br><span class="line">script statistics:</span><br><span class="line"> - statement latencies in milliseconds:</span><br><span class="line">         0.004  \set x random(73.33,135.05)</span><br><span class="line">         0.001  \set y random(3.51,53.33)</span><br><span class="line">       575.308  SELECT id,st_astext (position),ST_Distance (position,ST_SetSRID (ST_Point (:x,:y),4326),TRUE) AS idistance FROM t_user_position ORDER BY position &lt;-&gt; ST_SetSRID (ST_Point (:x,:y),4326) ASC LIMIT 1000;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>avg = 575.308 ms  左右</p>
</blockquote>
<h4 id="limit-200"><a href="#limit-200" class="headerlink" title="limit 200"></a>limit 200</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">transaction type: ./test_random_position.sql</span><br><span class="line">scaling factor: 1</span><br><span class="line">query mode: prepared</span><br><span class="line">number of clients: 5</span><br><span class="line">number of threads: 5</span><br><span class="line">duration: 60 s</span><br><span class="line">number of transactions actually processed: 4221</span><br><span class="line">latency average = 71.116 ms</span><br><span class="line">latency stddev = 56.307 ms</span><br><span class="line">tps = 70.254878 (including connections establishing)</span><br><span class="line">tps = 70.280466 (excluding connections establishing)</span><br><span class="line">script statistics:</span><br><span class="line"> - statement latencies in milliseconds:</span><br><span class="line">         0.004  \set x random(73.33,135.05)</span><br><span class="line">         0.001  \set y random(3.51,53.33)</span><br><span class="line">        71.139  SELECT id,st_astext (position),ST_Distance (position,ST_SetSRID (ST_Point (:x,:y),4326),TRUE) AS idistance FROM t_user_position ORDER BY position &lt;-&gt; ST_SetSRID (ST_Point (:x,:y),4326) ASC LIMIT 200;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>avg = 71.139  ms  左右</p>
</blockquote>
<h3 id="执行语句分析"><a href="#执行语句分析" class="headerlink" title="执行语句分析"></a>执行语句分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT ID,st_astext (POSITION),ST_Distance (POSITION,ST_SetSRID (ST_Point (10.961553,56.539728),4326),TRUE) AS idistance FROM t_user_position ORDER BY POSITION&lt;-&gt; ST_SetSRID (ST_Point (100.961319,100.539881),4326) ASC LIMIT 200;</span><br><span class="line"> </span><br><span class="line"> Limit  (cost=0.55..1144.35 rows=200 width=56) (actual time=3.466..69.526 rows=200 loops=1)</span><br><span class="line">   -&gt;  Index Scan using gist_t_user_position on t_user_position  (cost=0.55..1552065572.09 rows=271388146 width=56) (actual time=3.464..69.427 rows=200 loops=1)</span><br><span class="line">         Order By: (&quot;position&quot; &lt;-&gt; &apos;0101000020E610000080812040863D5940D5AE09698D225940&apos;::geometry)</span><br><span class="line"> Planning time: 0.298 ms</span><br><span class="line"> Execution time: 69.738 ms</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过limit  <code>100</code> <code>1000</code> <code>2000</code> <code>5000</code>多次分析</p>
<p>Index Scan using gist_t_user_position 索引搜索成正比增长 limit 的记录越多,  耗时越长 </p>
<p>硬盘的读取数据通过 <code>iostat</code> 监控大概在  <code>120MB</code>+/s 左右， 就已经跑满，主要性能瓶颈在，硬盘读方面</p>
</blockquote>
<h3 id="ST-DWithin-查找附近5000米的用户"><a href="#ST-DWithin-查找附近5000米的用户" class="headerlink" title="ST_DWithin 查找附近5000米的用户"></a>ST_DWithin 查找附近5000米的用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN ANALYZE SELECT ID</span><br><span class="line">	,</span><br><span class="line">	st_astext ( POSITION ),</span><br><span class="line">	ST_Distance (</span><br><span class="line">		POSITION,</span><br><span class="line">		ST_SetSRID ( ST_Point ( 10.961553, 56.539728 ), 4326 ),</span><br><span class="line">	TRUE </span><br><span class="line">	) AS idistance </span><br><span class="line">FROM</span><br><span class="line">	t_user_position </span><br><span class="line">WHERE</span><br><span class="line">	ST_DWithin (</span><br><span class="line">			POSITION :: geography,</span><br><span class="line">			ST_SetSRID (ST_Point ( 10.961319, 56.539881 ), 4326 ) :: geography,</span><br><span class="line">			5000,</span><br><span class="line">		TRUE </span><br><span class="line">		)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接进行全表扫描，性能很差，尽量使用 <-> 操作符进行获取附近的人</-></p>
</blockquote>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><hr>
<h3 id="在PostGIS中定义Point时，您何时决定使用以下哪项？"><a href="#在PostGIS中定义Point时，您何时决定使用以下哪项？" class="headerlink" title="在PostGIS中定义Point时，您何时决定使用以下哪项？"></a>在PostGIS中定义Point时，您何时决定使用以下哪项？</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ST_SetSRID(ST_MakePoint(lon,lat),4326)</span><br><span class="line">ST_SetSRID(ST_Point(long,lat),4326)</span><br><span class="line">ST_SetSRID(ST_GeomFromText(&apos;POINT(lon lat)&apos;,4326)</span><br><span class="line">ST_GeomFromEWKT(&apos;SRID=4326;POINT(lon lat)&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="测试语句"><a href="#测试语句" class="headerlink" title="测试语句"></a>测试语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\timing</span><br><span class="line">WITH test_make_gis_point AS (</span><br><span class="line">  SELECT &lt;POINT CONSTRUCTOR METHOD&gt;</span><br><span class="line">  FROM generate_series(1,100000)</span><br><span class="line">)</span><br><span class="line">SELECT count(*) FROM test_make_gis_point;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>ST_SetSRID(ST_MakePoint(random(), random()), 4326)</p>
<blockquote>
<p>平均160毫秒<br>和<code>ST_Point</code>差不多一致，迄今为止最快，并保留双点精度（无损）<br>使用数字坐标数据进行参数化查询的最简单方法</p>
</blockquote>
</li>
<li><p>ST_GeomFromText(‘POINT(‘ || random()::text || ‘ ‘ || random()::text || ‘)’, 4326)</p>
<blockquote>
<p>平均760毫秒<br>慢，当数字转换为文本时，然后将字符串拼接在一起，然后PostGIS需要解析它以查找数字<br>有损，由于数字 - &gt;文字 - &gt;数字转换</p>
</blockquote>
</li>
<li><p>ST_GeomFromEWKT(‘SRID=4326;POINT(‘ || random()::text || ‘ ‘ || random()::text || ‘)’)</p>
<blockquote>
<p>平均810毫秒</p>
</blockquote>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>1 亿数据量，查找附近1000个人，耗时平局在 35ms (之前有测试过，数据没有保存就不在上面重新测试了)</li>
<li>2.7亿数据量，查找附近1000个人。vg = 575.308 ms  左右，随着查找人数降低， 速度能明显提升，avg = 71.139  ms  左右，</li>
<li>根据系统监控，查找数据瓶颈主要在硬盘io读写方面</li>
<li>postgres  select count 跟索引无关，都会进行全表扫描， 可以通过存储过程函数通过事件触发方式(但是会影响 insert 、update等操作，根据业务酌情选择)，另外记录，或者使用缓存等等，其他方式进行优化</li>
<li><code>ST_DWithin</code>查找附近的直接进行全表扫描，性能很差，尽量使用 <code>&lt;-&gt;</code> 操作符进行获取附近的人</li>
</ul>
<p>​    </p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/28/hello-world/" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/21/Linux-SSH-Clone-Session/" rel="prev" title="Linux SSH Clone Session">
                Linux SSH Clone Session <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">buerle</p>
              <p class="site-description motion-element" itemprop="description">dev,note,postgres,postgresql,golang,php,linux,web,mysql,postgis</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#postgis-记录亿级数据测试"><span class="nav-number">1.</span> <span class="nav-text">postgis 记录亿级数据测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#资料参考理解"><span class="nav-number">1.1.</span> <span class="nav-text">资料参考理解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建测试需要的基本信息"><span class="nav-number">2.</span> <span class="nav-text">创建测试需要的基本信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建数据库-postgis-test"><span class="nav-number">2.1.</span> <span class="nav-text">创建数据库 postgis_test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建POSTGIS扩展"><span class="nav-number">2.2.</span> <span class="nav-text">创建POSTGIS扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-t-user-position-测试表"><span class="nav-number">2.3.</span> <span class="nav-text">创建 t_user_position 测试表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建生成数据的存储过程"><span class="nav-number">3.</span> <span class="nav-text">创建生成数据的存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#存储过程生成数据"><span class="nav-number">3.1.</span> <span class="nav-text">存储过程生成数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行命令"><span class="nav-number">3.2.</span> <span class="nav-text">执行命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#也可以使用pgbench生成数据"><span class="nav-number">3.3.</span> <span class="nav-text">也可以使用pgbench生成数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#再次执行脚本运行时间为1个小时"><span class="nav-number">3.3.1.</span> <span class="nav-text">再次执行脚本运行时间为1个小时</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看运行结果"><span class="nav-number">3.3.2.</span> <span class="nav-text">查看运行结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#count-查询数据"><span class="nav-number">3.3.3.</span> <span class="nav-text">count 查询数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看表空间"><span class="nav-number">3.3.4.</span> <span class="nav-text">查看表空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看表自增主键索引大小"><span class="nav-number">3.3.5.</span> <span class="nav-text">查看表自增主键索引大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#我们通过-pg-lt-gt-操作符在没有索引的情况下查询附近1000个人"><span class="nav-number">3.3.6.</span> <span class="nav-text">我们通过 pg  &lt;-&gt; 操作符在没有索引的情况下查询附近1000个人</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询的数据结果"><span class="nav-number">3.3.7.</span> <span class="nav-text">查询的数据结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加索引测试"><span class="nav-number">4.</span> <span class="nav-text">添加索引测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加索引"><span class="nav-number">4.0.1.</span> <span class="nav-text">添加索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引大小"><span class="nav-number">4.1.</span> <span class="nav-text">索引大小</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加测试脚本"><span class="nav-number">4.1.1.</span> <span class="nav-text">添加测试脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行pgbench"><span class="nav-number">4.1.2.</span> <span class="nav-text">执行pgbench</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-1000"><span class="nav-number">4.1.3.</span> <span class="nav-text">limit 1000</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-200"><span class="nav-number">4.1.4.</span> <span class="nav-text">limit 200</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行语句分析"><span class="nav-number">4.2.</span> <span class="nav-text">执行语句分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ST-DWithin-查找附近5000米的用户"><span class="nav-number">4.3.</span> <span class="nav-text">ST_DWithin 查找附近5000米的用户</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">5.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在PostGIS中定义Point时，您何时决定使用以下哪项？"><span class="nav-number">5.1.</span> <span class="nav-text">在PostGIS中定义Point时，您何时决定使用以下哪项？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试语句"><span class="nav-number">5.2.</span> <span class="nav-text">测试语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">5.3.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">buerle</span>

  

  
</div>







        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

  <script type="text/javascript" src="/js/src/love.js"></script>
</body>
</html>
